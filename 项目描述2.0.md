# 区间交易系统 2.0

## 项目概述
本项目实现了一个基于自创分析框架的区间交易系统，通过峰谷识别、关键价位计算和动态交易策略，在加密货币市场中进行区间交易。系统采用对数价格空间进行所有计算，确保不同价格水平下的算法一致性。

## 数据管道流程

### 1. 数据获取与预处理
- **数据源**: Binance永续合约前15个USDT交易对
- **时间范围**: 2年5分钟K线数据
- **数据格式**: 包含timestamp, open, high, low, close, volume等标准OHLCV字段
- **对数变换**: 对所有价格数据（open, high, low, close）进行对数变换：`log_price = log(price)`，并限制最小值为1e-6防止数值问题

### 2. 峰谷识别算法（HL算法）

#### 2.1 摆动高低点识别
- **参数**: 颗粒度参数g=3
- **摆动高点**: 对于K线高点H，如果满足H ≥ 前后各g根K线的高点，则H为摆动高点
- **摆动低点**: 对于K线低点L，如果满足L ≤ 前后各g根K线的低点，则L为摆动低点
- **滞后性**: 算法具有g根K线的滞后性，回测时需避免数据泄露

#### 2.2 峰谷去重算法
- **去重规则**: 对连续相邻的H或L进行去重
- **H去重**: 取数值最高的H，数值相等时取时间最早的
- **L去重**: 取数值最低的L，数值相等时取时间最早的
- **结果**: 形成H-L-H-L交替的峰谷序列

### 3. 关键价位计算

#### 3.1 观察窗口设置
- **窗口大小**: w=120（可调参数）
- **候选点**: 窗口内所有K线的high和low点，共2w个候选点
- **ATR计算**: 基于对数价格计算ATR，ATR周期为w

#### 3.2 吸引力得分算法
对于候选点high_n，计算其吸引力得分：

**得分区间**: `[high_n - band_width×ATR, high_n + band_width×ATR]`

**得分计算**:
1. 统计窗口内其他2w-1个点中，有多少个点落在得分区间内
2. 对每个落在区间内的点i，计算距离得分：`exp(-|point_i - high_n|/ATR)`
3. 同一根K线的high和low都满足条件时，只取数值较高的计入分数
4. 最终得分：`总得分/w`，确保得分在[0,1]范围内

**参数说明**:
- `band_width`: 带宽参数，默认0.1，控制得分区间的宽窄
- 得分越高表示该价位越具有支撑/阻力作用

#### 3.3 关键价位筛选
1. **阈值筛选**: 设定阈值threshold（默认0.1），筛选得分≥threshold的点
2. **两阶段筛选算法**:
   - **第一阶段**: 从2w个候选点中选择得分最高且高于阈值的点作为第一个候选关键价位
   - **区间排除**: 排除掉在区间[候选关键价位-ATR, 候选关键价位+ATR]内的所有候选点
   - **第二阶段**: 从区间外的剩余候选点中选择得分最高且高于阈值的点作为第二个候选关键价位
   - **验证**: 如果两个候选点都高于阈值，则确定关键价位
3. **价格差验证**: 要求`(key_1 - key_0) > ATR`（在真实价格空间中，确保量纲一致）
4. **确定关键价位**: 
   - key_1: 数值较高的关键价位
   - key_0: 数值较低的关键价位
### 4. 扩展价位计算

基于关键价位key_1和key_0，计算扩展价位：

**计算公式**（在对数价格空间中）:
- `level_-2 = key_0 - 2×(key_1 - key_0)`
- `level_-1 = key_0 - 1×(key_1 - key_0)`  
- `level_2 = key_0 + 2×(key_1 - key_0)`
- `level_3 = key_0 + 3×(key_1 - key_0)`

**物理意义**:
- level_-1, level_-2: 支撑位（做多区域）
- level_2, level_3: 阻力位（做空区域）

### 5. 动态Range计算机制

#### 5.1 观察窗口跟随K线移动
- **窗口滑动**: 每更新一根K线，观察窗口右移一根K线，淘汰最左边的K线，加入最新右边的已收盘K线
- **动态计算**: 在观察窗口内，每根新K线都会重新计算key_1和key_0以及扩展价位
- **实时更新**: 关键价位和扩展价位始终基于当前观察窗口内的最佳候选点

#### 5.2 Range计数规则
1. **Range开始**: 当存在key_1和key_0时，可以开始一个range（但不计数）
2. **Range计数**: 当价格触及扩展价位2或-1时，此时key_1和key_0不再更新，扩展价位也不再更新，range计数+1
3. **等待重启**: Range计数后，需要等待w根K线，然后重新开启观察窗口并再次随K线更新而移动

#### 5.3 关键价位动态更新
- **活跃期间**: 在Range活跃期间（未触及扩展价位前），key_1和key_0会随着新K线动态更新
- **停止更新**: 一旦扩展价位被触及，key_1和key_0立即停止更新，成为固定的交易信号
- **重新开始**: 等待w根K线后，重新开始寻找新的关键价位

### 6. 交易策略

#### 6.1 中性挂单策略
- **多单挂单**: 在level_-1处挂多单
  - 止损位: level_-2
  - 止盈位: level_2
  - 风险收益比: 3:1
- **空单挂单**: 在level_2处挂空单
  - 止损位: level_3  
  - 止盈位: level_-1
  - 风险收益比: 3:1

#### 6.2 订单管理
- **同时挂单**: 多单和空单同时挂出
- **OCO机制**: 一个方向成交后自动取消另一个方向的挂单
- **动态更新**: 关键价位更新时，挂单价格相应调整

#### 6.3 交易费用
- **手续费**: 0.1%（开仓和平仓各0.05%）
- **滑点**: 假设按挂单价格成交

### 7. 回测与优化

#### 7.1 性能指标
- **夏普比率**: 主要优化目标，衡量风险调整后收益
- **胜率**: 盈利交易占总交易的比例
- **总交易次数**: 回测期间产生的交易数量
- **最大回撤**: 最大连续亏损幅度

#### 7.2 参数优化
- **w**: 观察窗口大小，范围[60, 300]
- **band_width**: 吸引力得分带宽，范围[0.05, 0.15]  
- **threshold**: 关键价位筛选阈值，范围[0.05, 0.15]

#### 7.3 贝叶斯优化
- **优化算法**: 高斯过程回归 + 期望改进（EI）采集函数
- **搜索策略**: 先随机采样，再基于历史结果智能搜索
- **收敛条件**: 达到预设评估次数或收敛阈值

## 技术实现特点

### 1. 对数价格空间
- 所有价格计算在对数空间进行，确保不同价格水平下算法一致性
- ATR、吸引力得分、关键价位筛选都在对数空间计算
- 避免价格量级差异对算法性能的影响

### 2. 向量化计算
- 使用NumPy向量化操作，避免Python循环
- 吸引力得分采用O(N×W)滑动窗口算法，提高计算效率
- 针对M2 Mac 8GB内存优化，支持大数据集处理

### 3. 动态阈值
- 关键价位筛选阈值基于得分中位数动态计算
- 适应不同市场条件下的得分分布特征
- 提高算法在不同市场环境下的鲁棒性

### 4. 内存优化
- 分批处理大数据集，防止内存溢出
- 使用生成器模式处理大量K线数据
- 针对8GB内存限制进行优化

## 当前实现状态

✅ **已完成模块**:
- 数据获取与对数变换
- HL算法峰谷识别
- 吸引力得分计算
- 关键价位筛选
- 扩展价位计算
- 交易策略模拟
- 贝叶斯优化框架

🔄 **待优化问题**:
- 交易信号生成逻辑需要进一步调试
- 参数优化效果需要验证
- 更多交易对的数据测试

## 预期目标

通过参数优化和机器学习验证，寻找能够产生正期望值的交易模式，为后续的实时交易系统奠定基础。
